<!DOCTYPE html>
<script>
  function ok(v, msg) {
    window.parent.postMessage({status: "ok", result: !!v, message: msg}, "*");
  }

  function is(a, b, msg) {
    ok(a === b, msg + ", expected '" + b + "', got '" + a + "'");
  }

  function finish() {
    window.parent.postMessage({status: "done"}, "*");
  }

  function testFetch() {
    return fetch("fetch.txt").then(function(r) {
      return r.text();
    }).then(function(body) {
      is(body, "so fetch", "A fetch() Request should have the 'fetch' context");
    });
  }

  function testImage() {
    return new Promise(function(resolve, reject) {
      var img = document.createElement("img");
      img.src = "img.jpg";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testImageSrcSet() {
    return new Promise(function(resolve, reject) {
      var img = document.createElement("img");
      img.srcset = "responsive.jpg 100w";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testPicture() {
    return new Promise(function(resolve, reject) {
      var pic = document.createElement("picture");
      var img = document.createElement("img");
      pic.appendChild(img);
      img.src = "responsive.jpg?picture";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testAudio() {
    return new Promise(function(resolve, reject) {
      var audio = document.createElement("audio");
      audio.src = "audio.ogg";
      audio.preload = "metadata";
      // The service worker will respond with an existing audio only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      audio.onloadedmetadata = resolve;
      audio.onerror = reject;
    });
  }

  function testVideo() {
    return new Promise(function(resolve, reject) {
      var video = document.createElement("video");
      video.src = "video.ogg";
      video.preload = "metadata";
      // The service worker will respond with an existing video only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      video.onloadedmetadata = resolve;
      video.onerror = reject;
    });
  }

  function testBeacon() {
    ok(navigator.sendBeacon("beacon.sjs"), "Sending the beacon should succeed");
    // query the context from beacon.sjs
    return fetch("beacon.sjs?queryContext")
      .then(function(r) {
        return r.text();
      }).then(function(body) {
        is(body, "beacon", "The context for the intercepted beacon should be correct");
      });
  }

  function testCSPReport() {
    return new Promise(function(resolve, reject) {
      var iframe = document.createElement("iframe");
      iframe.src = "csp-violate.sjs";
      document.documentElement.appendChild(iframe);
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "csp-report") {
          is(e.data.context, "cspreport", "Expected the cspreport context on a CSP violation report");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          resolve();
        }
      }, false);
    });
  }

  function testEmbed() {
    return new Promise(function(resolve, reject) {
      var embed = document.createElement("embed");
      embed.src = "embed";
      document.documentElement.appendChild(embed);
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "embed") {
          // FIXME: Bug 1148030: This should be "embed".
          is(e.data.context, "object", "Expected the object context on an embed");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          resolve();
        }
      }, false);
    });
  }

  function testObject() {
    return new Promise(function(resolve, reject) {
      var object = document.createElement("object");
      object.data = "object";
      document.documentElement.appendChild(object);
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "object") {
          is(e.data.context, "object", "Expected the object context on an object");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          resolve();
        }
      }, false);
    });
  }

  function testFont() {
    return new Promise(function(resolve, reject) {
      var css = '@font-face { font-family: "sw-font"; src: url("font"); }';
      css += '* { font-family: "sw-font"; }';
      var style = document.createElement("style");
      style.appendChild(document.createTextNode(css));
      document.documentElement.appendChild(style);
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "font") {
          is(e.data.context, "font", "Expected the font context on an font");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          resolve();
        }
      }, false);
    });
  }

  function testIFrame() {
    return new Promise(function(resolve, reject) {
      var iframe = document.createElement("iframe");
      iframe.src = "iframe";
      document.documentElement.appendChild(iframe);
      // The service worker will respond with an existing document only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      iframe.onload = resolve;
      iframe.onerror = reject;
    });
  }

  function testFrame() {
    return new Promise(function(resolve, reject) {
      var frame = document.createElement("frame");
      frame.src = "frame";
      document.documentElement.appendChild(frame);
      // The service worker will respond with an existing document only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      frame.onload = resolve;
      frame.onerror = reject;
    });
  }

  function testInternal() {
    var isB2G = !navigator.userAgent.contains("Android") &&
                /Mobile|Tablet/.test(navigator.userAgent);
    if (isB2G) {
      // We can't open new windows on b2g, so skip this part of the test there.
      return Promise.resolve();
    }
    return new Promise(function(resolve, reject) {
      // Test this with a new window opened through script.  There are of course
      // other possible ways of testing this too.
      var win = window.open("newwindow", "_blank", "width=100,height=100");
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "newwindow") {
          is(e.data.context, "internal", "Expected the internal context on a newly opened window");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          win.close();
          resolve();
        }
      }, false);
    });
  }

  function testPing() {
    // FIXME: Temporarily disabled until bug 1148064 gets fixed.
    return Promise.resolve();
    return new Promise(function(resolve, reject) {
      var iframe = document.createElement("iframe");
      iframe.src = "ping.html";
      document.documentElement.appendChild(iframe);
      navigator.serviceWorker.addEventListener("message", function onMessage(e) {
        if (e.data.data == "ping") {
          is(e.data.context, "ping", "Expected the ping context on an anchor ping");
          navigator.serviceWorker.removeEventListener("message", onMessage);
          resolve();
        }
      }, false);
    });
  }

  Promise.all([
    testFetch(),
    testImage(),
    testImageSrcSet(),
    testPicture(),
    testAudio(),
    testVideo(),
    testBeacon(),
    testCSPReport(),
    testEmbed(),
    testObject(),
    testFont(),
    testIFrame(),
    testFrame(),
    testInternal(),
    testPing(),
  ])
  .then(function() {
    finish();
  }, function(e) {
    ok(false, "A promise was rejected: " + e);
    finish();
  });
</script>
