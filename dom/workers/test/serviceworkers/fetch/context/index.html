<!DOCTYPE html>
<script>
  function ok(v, msg) {
    window.parent.postMessage({status: "ok", result: !!v, message: msg}, "*");
  }

  function is(a, b, msg) {
    ok(a === b, msg + ", expected '" + b + "', got '" + a + "'");
  }

  function finish() {
    window.parent.postMessage({status: "done"}, "*");
  }

  function testFetch() {
    return fetch("fetch.txt").then(function(r) {
      return r.text();
    }).then(function(body) {
      is(body, "so fetch", "A fetch() Request should have the 'fetch' context");
    });
  }

  function testImage() {
    return new Promise(function(resolve, reject) {
      var img = document.createElement("img");
      img.src = "img.jpg";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testImageSrcSet() {
    return new Promise(function(resolve, reject) {
      var img = document.createElement("img");
      img.srcset = "responsive.jpg 100w";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testPicture() {
    return new Promise(function(resolve, reject) {
      var pic = document.createElement("picture");
      var img = document.createElement("img");
      pic.appendChild(img);
      img.src = "responsive.jpg?picture";
      // The service worker will respond with an existing image only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      img.onload = resolve;
      img.onerror = reject;
    });
  }

  function testAudio() {
    return new Promise(function(resolve, reject) {
      var audio = document.createElement("audio");
      audio.src = "audio.ogg";
      audio.preload = "metadata";
      // The service worker will respond with an existing audio only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      audio.onloadedmetadata = resolve;
      audio.onerror = reject;
    });
  }

  function testVideo() {
    return new Promise(function(resolve, reject) {
      var video = document.createElement("video");
      video.src = "video.ogg";
      video.preload = "metadata";
      // The service worker will respond with an existing video only if the
      // Request has the correct context, otherwise the Promise will get
      // rejected and the test will fail.
      video.onloadedmetadata = resolve;
      video.onerror = reject;
    });
  }

  function testBeacon() {
    ok(navigator.sendBeacon("beacon.sjs"), "Sending the beacon should succeed");
    // query the context from beacon.sjs
    return fetch("beacon.sjs?queryContext")
      .then(function(r) {
        return r.text();
      }).then(function(body) {
        is(body, "beacon", "The context for the intercepted beacon should be correct");
      });
  }

  Promise.all([
    testFetch(),
    testImage(),
    testImageSrcSet(),
    testPicture(),
    testAudio(),
    testVideo(),
    testBeacon(),
  ])
  .then(function() {
    finish();
  }, function(e) {
    ok(false, "A promise was rejected: " + e);
    finish();
  });
</script>
