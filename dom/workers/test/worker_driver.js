




























function workerTestExec(script) {
  SimpleTest.waitForExplicitFinish();
  var worker = new Worker('worker_wrapper.js');
  worker.onmessage = function(event) {
    if (event.data.type == 'finish') {
      SimpleTest.finish();

    } else if (event.data.type == 'status') {
      ok(event.data.status, event.data.msg);

    } else if (event.data.type == 'getPrefs') {
      var result = {};
      event.data.prefs.forEach(function(pref) {
        result[pref] = SpecialPowers.Services.prefs.getBoolPref(pref);
      });
      worker.postMessage({
        type: 'returnPrefs',
        prefs: event.data.prefs,
        result: result
      });

    } else if (event.data.type == 'getPermissions') {
      var result = {};
      event.data.permissions.forEach(function(permission) {
        result[permission] = SpecialPowers.hasPermission(permission, window.document);
      });
      worker.postMessage({
        type: 'returnPermissions',
        permissions: event.data.permissions,
        result: result
      });

    } else if (event.data.type == 'getVersion') {
      var result = SpecialPowers.Cc['@mozilla.org/xre/app-info;1'].getService(SpecialPowers.Ci.nsIXULAppInfo).version;
      worker.postMessage({
        type: 'returnVersion',
        result: result
      });

    } else if (event.data.type == 'getUserAgent') {
      worker.postMessage({
        type: 'returnUserAgent',
        result: navigator.userAgent
      });
    } else if (event.data.type == 'getOSCPU') {
      worker.postMessage({
        type: 'returnOSCPU',
        result: navigator.oscpu
      });
    }
  }

  worker.onerror = function(event) {
    ok(false, 'Worker had an error: ' + event.data);
    SimpleTest.finish();
  };

  worker.postMessage({ script: script });
}
