# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.

abs_dist := $(abspath $(DIST))
webidl_base := $(topsrcdir)/dom/webidl

# Generated by moz.build
include webidlsrcs.mk

ifdef GNU_CC
CXXFLAGS += -Wno-uninitialized
endif

# These come from webidlsrcs.mk.
CPPSRCS += $(globalgen_sources) $(unified_binding_cpp_files)

# Generated bindings reference *Binding.h, not mozilla/dom/*Binding.h. And,
# since we generate exported bindings directly to $(DIST)/include, we need
# to add that path to the search list. We need to ensure the $(DIST) path
# occurs before '.' because old builds generated .h files into '.'
# before copying them to $(DIST). Those old .h files won't get updated
# any more and thus using them could result in build failures due to
# mismatches. This consideration shouldn't be relevant after CLOBBER
# is touched.
#
# Ideally, binding generation uses the prefixed header file names.
# Bug 932092 tracks.
LOCAL_INCLUDES += -I$(DIST)/include/mozilla/dom

PYTHON_UNIT_TESTS += $(srcdir)/mozwebidl/test/test_mozwebidl.py

include $(topsrcdir)/config/rules.mk


css2properties_dependencies = \
  $(topsrcdir)/layout/style/nsCSSPropList.h \
  $(topsrcdir)/layout/style/nsCSSPropAliasList.h \
  $(webidl_base)/CSS2Properties.webidl.in \
  $(webidl_base)/CSS2PropertiesProps.h \
  $(srcdir)/GenerateCSS2PropertiesWebIDL.py \
  $(GLOBAL_DEPS) \
  $(NULL)

CSS2Properties.webidl: $(css2properties_dependencies)
	$(CPP) $(DEFINES) $(ACDEFINES) -I$(topsrcdir)/layout/style \
	  $(webidl_base)/CSS2PropertiesProps.h | \
	    PYTHONDONTWRITEBYTECODE=1 $(PYTHON) \
	      $(srcdir)/GenerateCSS2PropertiesWebIDL.py \
	      $(webidl_base)/CSS2Properties.webidl.in > $@

# Most of the logic for dependencies lives inside Python so it can be
# used by multiple build backends. We simply have rules to generate
# and include the .pp file. This will pull in additional dependencies
# on codegen.pp which will cause any .webidl or .py file change to
# result in regeneration.
codegen_dependencies := \
  $(nonstatic_webidl_files) \
  $(GLOBAL_DEPS) \
  $(NULL)

include codegen.pp

codegen.pp: $(codegen_dependencies)
	$(call py_action,webidl,$(srcdir))
	@$(TOUCH) $@

export:: codegen.pp

GARBAGE += \
  codegen.pp \
  codegen.json \
  parser.out \
  WebIDLGrammar.pkl \
  $(wildcard *.h) \
  $(wildcard *.cpp) \
  $(wildcard *.webidl) \
  $(NULL)
