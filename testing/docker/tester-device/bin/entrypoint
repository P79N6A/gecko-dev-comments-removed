#! /bin/bash -e

echo "Validating Task"
python /home/worker/bin/validate_task.py

echo "Retrieving device"
res=`curl --request POST -H "Content-Type: application/json" -d "$DEVICE_CAPABILITIES" http://$CLOUD_HOST/device`
status=`echo $res | jq .session`

if [[ $status == 'null' ]]; then
    echo "Session could not be created with a device."
    exit -1
fi

export SESSION_ID=`echo $res | jq .session.id`
export SERIAL_ID=`echo $res | jq -r .proxies.adb.serialId`
export ADB_HOST=`echo $res | jq .proxies.adb.forwardHost`
export ADB_PORT=`echo $res | jq .proxies.adb.port`
export MARIONETTE_HOST=`echo $res | jq .proxies.marionette.forwardHost`
export MARIONETTE_PORT=`echo $res | jq .proxies.marionette.port`
export PROXY_HOST=`echo $res | jq -r .proxyHost`
echo "Retrieved device.  Session: $SESSION_ID"

curl -o /home/worker/data/device.json -s -H "Accept: application/json" http://$CLOUD_HOST/device/properties

eval $@
